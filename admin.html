<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Kelas 8 Benevolent</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #f4f4f4; display: flex; flex-direction: column; min-height: 100vh; }
        nav { background: rgba(255,255,255,0.9); padding: 15px 20px; position: fixed; top: 0; width: 100%; z-index: 10; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .nav-left { display: flex; align-items: center; gap: 10px; }
        .nav-logo { width: 40px; height: auto; }
        .nav-text { color: #333; font-weight: 600; font-size: 1.2em; }
        .nav-right { display: flex; gap: 25px; align-items: center; }
        nav a { text-decoration: none; color: #333; font-weight: 500; padding: 10px 15px; border-radius: 25px; transition: all 0.3s; }
        nav a:hover { background: rgba(0,123,255,0.1); color: #007bff; }
        .user-profile { color: #333; font-weight: 500; }
        main { margin-top: 80px; padding: 20px; flex: 1; max-width: 1200px; margin: 80px auto 0; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 8px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: #e9ecef; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .tab-btn.active, .tab-btn:hover { background: #007bff; color: white; }
        .section { display: none; }
        .section.active { display: block; }
        button, .btn { background: #6d6d6d; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #555; transform: translateY(-2px); }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .list { list-style: none; padding: 0; }
        .item { background: #f9f9f9; margin: 10px 0; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .item h3 { margin: 0 0 10px 0; color: #007bff; }
        .item p { margin: 0; color: #555; }
        .delete-btn { background: #dc3545; color: white; }
        .edit-btn { background: #ffc107; color: black; }
        .toggle-btn { background: #28a745; color: white; }
        .toggle-btn.inactive { background: #6c757d; }
        footer { text-align: center; padding: 10px; background: #f8f9fa; border-top: 1px solid #ddd; margin-top: auto; }
    </style>
</head>
<body>
    <nav>
        <div class="nav-left">
            <img src="img/logo.png" alt="Logo" class="nav-logo">
            <span class="nav-text">Admin - Kelas 8 Benevolent</span>
        </div>
        <div class="nav-right">
            <span class="user-profile">Welcome, <span id="userName"></span></span>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>
    <main>
        <h2 id="pageTitle">Kelola Prestasi</h2>
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('prestasi')">Prestasi</button>
            <button class="tab-btn" onclick="showTab('karya')">Karya Siswa</button>
            <button class="tab-btn" id="moderatorTab" onclick="showTab('moderator')" style="display: none;">Moderator</button>
        </div>
        <div id="prestasi-section" class="section active">
            <h3 id="prestasiFormTitle">Tambah Prestasi Baru</h3>
            <form id="addForm">
                <input type="text" id="title" placeholder="Judul Prestasi" required>
                <textarea id="description" placeholder="Deskripsi Prestasi" rows="4" required></textarea>
                <button type="submit" id="prestasiSubmitBtn">Tambah Prestasi</button>
                <button type="button" id="cancelPrestasiBtn" style="display: none;" onclick="cancelEdit('prestasi')">Batal</button>
            </form>
            <h3>Daftar Prestasi</h3>
            <ul class="list" id="prestasiList"></ul>
            <p id="noPrestasi">Belum ada prestasi.</p>
        </div>
        <div id="karya-section" class="section">
            <h3 id="karyaFormTitle">Tambah Karya Siswa Baru</h3>
            <form id="addKaryaForm">
                <input type="text" id="karyaTitle" placeholder="Judul Karya" required>
                <textarea id="karyaDescription" placeholder="Deskripsi Karya" rows="4" required></textarea>
                <button type="submit" id="karyaSubmitBtn">Tambah Karya</button>
                <button type="button" id="cancelKaryaBtn" style="display: none;" onclick="cancelEdit('karya')">Batal</button>
            </form>
            <h3>Daftar Karya Siswa</h3>
            <ul class="list" id="karyaList"></ul>
            <p id="noKarya">Belum ada karya.</p>
        </div>
        <div id="moderator-section" class="section">
            <h3 id="modFormTitle">Kelola Moderator</h3>
            <form id="addModForm">
                <input type="text" id="modUsername" placeholder="Username" required>
                <input type="password" id="modPassword" placeholder="Password" required>
                <label><input type="checkbox" id="modActive" checked> Aktif</label>
                <button type="submit" id="modSubmitBtn">Tambahkan sebagai Moderator</button>
                <button type="button" id="addAdminBtn">Tambahkan sebagai Admin</button>
                <button type="button" id="cancelModBtn" style="display: none;" onclick="cancelEdit('moderator')">Batal</button>
            </form>
            <h4>Daftar Moderator</h4>
            <ul class="list" id="moderatorList"></ul>
            <h4>Daftar Admin</h4>
            <ul class="list" id="adminList"></ul>
        </div>
    </main>
    <footer>Â© 2025 ICT 8 Benevolent <a href="">AffanEkaP</a></footer>
    <script>
        const API_URL = 'https://kdgjpvebpgxbtdxdsaff.supabase.co/functions/v1/accounts-api';  // URL Supabase
        const SUPABASE_ANON_KEY = 'sb_publishable_Hn-ADpLFOMImD47sSB_8wQ_OG8vuMa1';  // Anon key dari command curl Anda

        // Helper fetch dengan header Supabase
        async function apiFetch(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` };
            return fetch(`${API_URL}${endpoint}`, { headers, ...options });
        }

        // Cek user dari localStorage
        const userRole = localStorage.getItem('userRole');
        const userName = localStorage.getItem('userName') || 'User';
        if (!userRole) window.location.href = 'login.html';
        document.getElementById('userName').textContent = userName;
        if (userRole === 'admin') document.getElementById('moderatorTab').style.display = 'inline-block';

        let editingId = null;
        let editingType = null;

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        function showTab(tab) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab + '-section').classList.add('active');
            event.target.classList.add('active');
            document.getElementById('pageTitle').textContent = `Kelola ${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
            loadData(tab);
        }

        async function loadData(type) {
            try {
                let response, data, listId, noId, itemClass;
                if (type === 'prestasi') {
                    response = await apiFetch('/prestasi');
                    data = await response.json();
                    listId = 'prestasiList'; noId = 'noPrestasi'; itemClass = 'prestasi-item';
                } else if (type === 'karya') {
                    response = await apiFetch('/karya');
                    data = await response.json();
                    listId = 'karyaList'; noId = 'noKarya'; itemClass = 'karya-item';
                } else if (type === 'moderator' && userRole === 'admin') {
                    response = await apiFetch('/accounts');
                    const accounts = await response.json();
                    loadAccounts(accounts);
                    return;
                }
                renderList(listId, noId, data, itemClass, type);
            } catch (err) {
                console.error('Error loading:', err);
            }
        }

        function renderList(listId, noId, data, itemClass, type) {
            const list = document.getElementById(listId);
            const noMsg = document.getElementById(noId);
            list.innerHTML = '';
            if (data.length === 0) {
                noMsg.style.display = 'block';
            } else {
                noMsg.style.display = 'none';
                data.forEach(item => {
                    const li = document.createElement('li');
                    li.className = itemClass;
                    li.innerHTML = `
                        <div><h3>${item.title || item.username}</h3><p>${item.description || `Role: ${item.role} | Status: ${item.active ? 'Aktif' : 'Nonaktif'}`}</p></div>
                        <div>
                            ${type === 'moderator' ? `<button class="toggle-btn ${item.active ? '' : 'inactive'}" onclick="toggleActive('${item.username}')">${item.active ? 'Nonaktifkan' : 'Aktifkan'}</button>` : ''}
                            <button class="edit-btn" onclick="editItem(${item.id || `'${item.username}'`}, '${type}')">Edit</button>
                            <button class="delete-btn" onclick="deleteItem(${item.id || `'${item.username}'`}, '${type}')">Hapus</button>
                        </div>
                    `;
                    list.appendChild(li);
                });
            }
        }

        async function loadAccounts(accounts) {
            const mods = accounts.filter(a => a.role === 'moderator');
            const admins = accounts.filter(a => a.role === 'admin');
            renderList('moderatorList', null, mods, 'moderator-item', 'moderator');
            renderList('adminList', null, admins, 'admin-item', 'admin');
        }

        function editItem(id, type) {
            if (type === 'prestasi') {
                apiFetch(`/prestasi/${id}`).then(r => r.json()).then(item => {
                    document.getElementById('title').value = item.title;
                    document.getElementById('description').value = item.description;
                    setEditMode('prestasi', id);
                });
            } else if (type === 'karya') {
                apiFetch(`/karya/${id}`).then(r => r.json()).then(item => {
                    document.getElementById('karyaTitle').value = item.title;
                    document.getElementById('karyaDescription').value = item.description;
                    setEditMode('karya', id);
                });
            } else if (type === 'moderator') {
                apiFetch(`/accounts/${id}`).then(r => r.json()).then(item => {
                    document.getElementById('modUsername').value = item.username;
                    document.getElementById('modActive').checked = item.active;
                    setEditMode('moderator', id);
                });
            }
        }

        function setEditMode(type, id) {
            editingId = id;
            editingType = type;
            const btn = document.getElementById(type === 'prestasi' ? 'prestasiSubmitBtn' : type === 'karya' ? 'karyaSubmitBtn' : 'modSubmitBtn');
            const title = document.getElementById(type === 'prestasi' ? 'prestasiFormTitle' : type === 'karya' ? 'karyaFormTitle' : 'modFormTitle');
            const cancel = document.getElementById(type === 'prestasi' ? 'cancelPrestasiBtn' : type === 'karya' ? 'cancelKaryaBtn' : 'cancelModBtn');
            btn.textContent = `Update ${type}`;
            title.textContent = `Edit ${type}`;
            cancel.style.display = 'inline-block';
        }

        function cancelEdit(type) {
            editingId = null;
            editingType = null;
            const form = type === 'prestasi' ? 'addForm' : type === 'karya' ? 'addKaryaForm' : 'addModForm';
            document.getElementById(form).reset();
            const btn = document.getElementById(type === 'prestasi' ? 'prestasiSubmitBtn' : type === 'karya' ? 'karyaSubmitBtn' : 'modSubmitBtn');
            const title = document.getElementById(type === 'prestasi' ? 'prestasiFormTitle' : type === 'karya' ? 'karyaFormTitle' : 'modFormTitle');
            const cancel = document.getElementById(type === 'prestasi' ? 'cancelPrestasiBtn' : type === 'karya' ? 'cancelKaryaBtn' : 'cancelModBtn');
            btn.textContent = `Tambah ${type}`;
            title.textContent = `Tambah ${type} Baru`;
            cancel.style.display = 'none';
        }

        document.getElementById('addForm').addEventListener('submit', async e => {
            e.preventDefault();
            const data = { title: document.getElementById('title').value, description: document.getElementById('description').value };
            const method = editingId ? 'PUT' : 'POST';
            const url = editingId ? `/prestasi/${editingId}` : '/prestasi';
            await apiFetch(url, { method, body: JSON.stringify(data) });
            cancelEdit('prestasi');
            loadData('prestasi');
        });

        document.getElementById('addKaryaForm').addEventListener('submit', async e => {
            e.preventDefault();
            const data = { title: document.getElementById('karyaTitle').value, description: document.getElementById('karyaDescription').value };
            const method = editingId ? 'PUT' : 'POST';
            const url = editingId ? `/karya/${editingId}` : '/karya';
            await apiFetch(url, { method, body: JSON.stringify(data) });
            cancelEdit('karya');
            loadData('karya');
        });

        document.getElementById('addModForm').addEventListener('submit', async e => {
            e.preventDefault();
            if (userRole !== 'admin') return alert('Akses ditolak!');
            const data = { username: document.getElementById('modUsername').value, password: document.getElementById('modPassword').value, role: 'moderator', active: document.getElementById('modActive').checked };
            const method = editingId ? 'PUT' : 'POST';
            const url = editingId ? `/accounts/${editingId}` : '/register';
            await apiFetch(url, { method, body: JSON.stringify(data) });
            cancelEdit('moderator');
            loadData('moderator');
        });

        document.getElementById('addAdminBtn').addEventListener('click', async () => {
            if (userRole !== 'admin') return document.getElementById('addAdminBtn').addEventListener('click', async () => {
            if (userRole !== 'admin') return alert('Akses ditolak!');
            const data = { username: document.getElementById('modUsername').value, password: document.getElementById('modPassword').value, role: 'admin' };
            await apiFetch('/register', { method: 'POST', body: JSON.stringify(data) });
            document.getElementById('addModForm').reset();
            loadData('moderator');
        });

        async function deleteItem(id, type) {
            if (!confirm(`Apakah Anda yakin ingin menghapus ${type} ini?`)) return;
            let url;
            if (type === 'prestasi') url = `/prestasi/${id}`;
            else if (type === 'karya') url = `/karya/${id}`;
            else if (type === 'moderator' || type === 'admin') url = `/accounts/${id}`;
            await apiFetch(url, { method: 'DELETE' });
            loadData(type);
        }

        async function toggleActive(username) {
            if (userRole !== 'admin') return alert('Akses ditolak!');
            const response = await apiFetch('/accounts');
            const accounts = await response.json();
            const account = accounts.find(acc => acc.username === username);
            if (account) {
                await apiFetch(`/accounts/${username}`, {
                    method: 'PUT',
                    body: JSON.stringify({ role: account.role, active: !account.active })
                });
                loadData('moderator');
            }
        }

        window.onload = function() {
            loadData('prestasi');
            loadData('karya');
            if (userRole === 'admin') loadData('moderator');
        };
    </script>
</body>
</html>
